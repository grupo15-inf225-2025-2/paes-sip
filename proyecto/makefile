# Variables generales
IMAGE_NAME = proyecto-app

DB_USER ?= postgres
DB_PASSWORD ?= postgres
DB_PORT_HOST ?= 5432
DB_PORT_CONTAINER ?= 5432
BACKEND_PORT_HOST ?= 3001
APP_PORT_HOST ?= 5173
DB_NAME ?= myapp

export DB_USER DB_PASSWORD DB_PORT_HOST DB_PORT_CONTAINER BACKEND_PORT_HOST APP_PORT_HOST DB_NAME

# Variables dinÃ¡micas
CONTAINER_NAME = proyecto-app
ENV_FILE = .env

# Dependencias
BACKEND_DEPS = express cors pg sequelize dotenv axios
FRONTEND_DEPS = react react-dom react-router-dom axios vite @vitejs/plugin-react

.PHONY: check-env build build-backend build-frontend run start stop run-db install-deps install-backend install-frontend clean clean-all help


check-env:
	@if [ ! -f $(ENV_FILE) ]; then \
		echo "âš™ï¸  Archivo .env no encontrado. Creando uno nuevo..."; \
		echo "# =============================" > $(ENV_FILE); \
		echo "# âš™ï¸ CONFIGURACIÃ“N GENERAL" >> $(ENV_FILE); \
		echo "# =============================" >> $(ENV_FILE); \
		echo "APP_PORT_HOST=$(APP_PORT_HOST)" >> $(ENV_FILE); \
		echo "BACKEND_PORT_HOST=$(BACKEND_PORT_HOST)" >> $(ENV_FILE); \
		echo "" >> $(ENV_FILE); \
		echo "# =============================" >> $(ENV_FILE); \
		echo "# ðŸ—„ï¸ CONFIGURACIÃ“N BASE DE DATOS" >> $(ENV_FILE); \
		echo "# =============================" >> $(ENV_FILE); \
		echo "DB_USER=$(DB_USER)" >> $(ENV_FILE); \
		echo "DB_PASSWORD=$(DB_PASSWORD)" >> $(ENV_FILE); \
		echo "DB_PORT_HOST=$(DB_PORT_HOST)" >> $(ENV_FILE); \
		echo "DB_PORT_CONTAINER=$(DB_PORT_CONTAINER)" >> $(ENV_FILE); \
		echo "DB_NAME=$(DB_NAME)" >> $(ENV_FILE); \
		echo "âœ… Archivo .env creado correctamente."; \
	else \
		echo "âœ… Archivo .env encontrado."; \
	fi


build: check-env build-backend build-frontend
	docker compose build

build-backend:
	@echo "Construyendo imagen del backend..."
	docker build -t $(IMAGE_NAME)-backend -f server/Dockerfile ./server

build-frontend:
	@echo "Construyendo imagen del frontend..."
	docker build -t $(IMAGE_NAME)-frontend -f cliente/Dockerfile ./cliente


run: check-env run-db
	@echo "Iniciando aplicaciÃ³n en rama '$(BRANCH)'..."
	docker compose up -d --build
	@echo "Frontend disponible en ðŸ‘‰ http://localhost:$(APP_PORT_HOST)"
	@echo "Backend disponible en  ðŸ‘‰ http://localhost:$(BACKEND_PORT_HOST)"
	@echo "Resultados API en      ðŸ‘‰ http://localhost:$(BACKEND_PORT_HOST)/api/resultados/listar"
	@echo "Base de datos en       ðŸ‘‰ localhost:$(DB_PORT_HOST)"


start:
	@echo "Iniciando contenedores existentes..."
	@docker compose start && \
		echo "âœ… AplicaciÃ³n iniciada correctamente." || \
		echo "âš ï¸  Error al iniciar. Prueba 'make run' primero."

stop:
	@echo "ðŸ›‘ Deteniendo contenedores..."
	@docker compose stop && \
		echo "ðŸ§± Contenedores detenidos. Usa 'make start' para reiniciar." || \
		echo "âš ï¸  Error al detener contenedores."


run-db: check-env
	@echo "Iniciando PostgreSQL..."
	@docker compose up -d db
	@sleep 5
	@echo "âœ… PostgreSQL listo en localhost:$(DB_PORT_HOST)"


clean:
	@echo "ðŸ§¹ Eliminando contenedores..."
	@docker compose down
	@echo "âœ… Contenedores eliminados."

clean-all: clean
	@echo "ðŸ’£ Eliminando imÃ¡genes y volÃºmenes..."
	@docker rmi -f $(IMAGE_NAME)-backend $(IMAGE_NAME)-frontend 2>/dev/null || true
	@docker volume rm -f proyecto_postgres_data 2>/dev/null || true
	@echo "âœ… Limpieza completa."


help:
	@echo "Comandos disponibles:"
	@echo "  make build           â†’ Construye todas las imÃ¡genes Docker"
	@echo "  make build-backend   â†’ Construye solo la imagen del backend"
	@echo "  make build-frontend  â†’ Construye solo la imagen del frontend"
	@echo "  make run             â†’ Inicia toda la aplicaciÃ³n (frontend, backend y DB)"
	@echo "  make run-db          â†’ Inicia solo la base de datos"
	@echo "  make start           â†’ Inicia contenedores existentes"
	@echo "  make stop            â†’ Detiene contenedores sin eliminarlos"
	@echo "  make clean           â†’ Elimina contenedores"
	@echo "  make clean-all       â†’ Elimina contenedores, imÃ¡genes y volÃºmenes"
	@echo "  make help            â†’ Muestra esta ayuda"
